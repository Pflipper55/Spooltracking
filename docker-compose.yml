version: "3.8"

services:
  db:
    image: mcr.microsoft.com/mssql/server:2019-latest
    container_name: spool_db
    platform: linux/amd64
    environment:
      - ACCEPT_EULA=Y
    ports:
      - "1433:1433"
    secrets:
      - db_password
    volumes:
      - db_data:/var/opt/mssql
    command: /bin/bash -c "export SA_PASSWORD=$(cat /run/secrets/db_password) && /opt/mssql/bin/sqlservr"

  api:
    build:
      context: ./SpooltrackingAPI
      dockerfile: Dockerfile
    image: spooltrackingapi:local
    container_name: spool_api
    depends_on:
      - db
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
    secrets:
      - db_password
    entrypoint: >
      /bin/bash -c 'export SPOOL_DB_CONN="Server=db,1433;Database=SpooltrackingDb;User Id=sa;Password=$(cat /run/secrets/db_password);TrustServerCertificate=True;" && dotnet SpooltrackingAPI.dll'
    ports:
      - "5000:80"
    restart: unless-stopped

  frontend:
    build:
      context: ./spooltracking
      dockerfile: Dockerfile
    image: spooltrackingui:local
    container_name: spool_ui
    depends_on:
      - api
    environment:
      - API_HOST=api
      - API_PORT=80
    ports:
      - "4200:4200"
    restart: unless-stopped

secrets:
  db_password:
    file: ./secrets/db_password.txt

volumes:
  db_data: